---
layout: post
title: 커널 오브젝트
categories: OS
comments: true
language: ko
---



**커널 오브젝트란 커널에 의해 관리되는 데이터 블록을 말한다.**
이건 약간 추상적인 개념이라 우선 커널 오브젝트들의 공통적인 특성에 대해 살펴보자.

우선 운영체제는 Access token object, Event object, File object, Mutex object, Thread object 등 다양한 형태의 커널 오브젝트를 생성 및 조작한다.

### 커널 오브젝트의 특징

**특징 1: 오직 커널만..**

- 커널 오브젝트는 커널에 의해서만 접근이 가능(어플리케이션에서 메모리 접근하여 수정 X)
- 하지만 MS는 커널 구조체 내용에 접근하기 위한 정제된 함수들을 제공하고 이것을 사용하면 접근 가능

**특징 2: 핸들**
- 커널 오브젝트 생성 함수를 호출하면 함수는 커널의 **핸들** 값을 반환.
- 이는 32비트 윈도우에서 32비트, 64비트 윈도우에서 64비트
- 다양한 함수의 매개변수로 전달되며 OS는 어떤 커널 오브젝트를 조작할 것인지 구분 가능

**특징 3: 사용 카운트(Usage count)를 갖는다.**
- 커널 오브젝트는 커널에 의해서 소유되므로 어떤 프로세스가 특정 함수로 커널 오브젝트를 생성 후 종료되더라도 커널 오브젝트가 프로세스와 함께 소멸되는 것은 아님.
- 사실 대부분의 경우는 커널 오브젝트도 같이 소멸되는 것이 맞는데 일종의 프로세스간의 글로벌 래퍼런스 카운팅을 하고 있어 다른 프로세스에서도 사용 중이면 생성한 프로세스가 소멸되도 커널 오브젝트는 삭제되지 않음.
- 이를 **Usage conut**라고 부르며 모든 커널오브젝트는 이 값을 가지고 있음. 0이 되면 소멸

**특징 4: 보안 디스크립터(Security descriptor)를 갖는다.**
- 누가 커널 오브젝트를 소유하고, 어떻게 공유되고, 각 사용자의 접근 권한은 어떻게 되는지 서술된 구조체.
- 커널 오브젝트 생성 함수의 인자로 전달하면 디테일 설정 가능.
- 파일 맵핑 함수를 예로들어 보겠음
```
    // 커널 오브젝트 생성 함수
    HANDLE CreateFileMappingA(
    HANDLE                hFile,
    LPSECURITY_ATTRIBUTES lpFileMappingAttributes, // 이 부분으로 보안 정보를 받는다.
    DWORD                 flProtect,
    DWORD                 dwMaximumSizeHigh,
    DWORD                 dwMaximumSizeLow,
    LPCSTR                lpName
    );

    // 커널 오브젝트 사용 함수. 사용자가 권한이 없으면 NULL Handle 반환
    // ERROR_ACCESS_DENIED 에러 발생
    HANDLE OpenFileMappingA(
    DWORD  dwDesiredAccess,
    BOOL   bInheritHandle,
    LPCSTR lpName
    );
```
- 윈도우에서 LPSECURITY_ATTRIBUTES를 인자로 받는 함수가 있다면 커널 오브젝트를 생성한다고 봐도 무방함

### 프로세스의 커널 오브젝트 핸들 테이블

프로세스가 초기화되면 운영체제는 프로세스를 위해 커널 오브젝트 핸들 테이블을 생성한다.
이는 커널 오브젝트의 메모리 블록을 가리키는 포인터를 갖고 있으며 프로세스에서 커널 오브젝트를 생성하면 테이블이 채워진다.
만약 CloseHandle() 등의 함수를 호출하며 명시적으로 커널 오브젝트를 더 이상 사용 안하겠고 알려주면 Usage count를 감소시키고 커널 테이블의 값도 다시 비워준다.

### 프로세스간 커널 오브젝트의 경우

프로세스간에 커널 오브젝트를 공유하는 경우는 빈번하게 발생할 수 있다. 예를들면
- file mapping object는 두 프로세스 사이에서 데이터의 블록을 공유하게 해준다.
- mailslot과 named pipe를 사용하면 네트워크로 연결된 서로 다른 머신에서 데이터 주고 받을 수 있음
- mutex, semaphore, event는 서로 다른 프로세스에서 수행되는 스레드간 동기화를 가능하게 해줌. 이를 이용하면 한 어플리케이션이 특정 작업을 완료했을때 다른 어플리케이션 그 사실을 알게 할 수 있다.

하지만 프로세스간에 커널 오브젝트를 공유하는 것은 쉽지 않은데, 커널 오브젝트의 핸들은 프로세스별로 고유한 값을 가지기 때문이다 -0-;; 보안과 안정성을 얻기 위해서 이렇게 설계되었는데 만약 커널 오브젝트 핸들 값이 전역적인 값이라면 어떤 프로세스든 다른 프로세스에서 사용하는 커널 오브젝트를 쉽게 얻어올 수 있고 이를 통해 다른 프로세스가 오동작하게 만드는 것도 쉽게 가능할 것이다.

그럼 어떻게 커널 오브젝트를 공유할 수 있는지 알아보자.

#### 1. 오브젝트 핸들의 상속을 이용하는 방법
